<!--pages/take-picture/take-picture.wxml-->
<view class="take-picture-container">
  <!-- 拍摄界面 -->
  <view class="capture-view" wx:if="{{currentStep === 'capture'}}">
    <camera 
      class="camera" 
      device-position="back" 
      flash="off"
      binderror="onCameraError"
      bindready="onCameraReady"
    >
      <cover-view class="camera-overlay">
        <cover-view class="camera-header" style="padding-top: {{statusBarHeight}}px; height: {{menuButtonInfo.height}}px;">
          <cover-view class="camera-title">拍一拍</cover-view>
        </cover-view>
        
        <cover-view class="camera-guide">
          <cover-view class="guide-frame" style="width: {{frameSize}}px; height: {{frameSize}}px;"></cover-view>
          <cover-view class="guide-text">将食物放入框内</cover-view>
        </cover-view>
        
        <cover-view class="camera-controls">
          <cover-view class="control-btn album-btn" bindtap="chooseFromAlbum">
            <cover-view class="album-icon-wrapper">
              <cover-image class="album-icon" src="/assets/take-picture/icon-picture.png" mode="aspectFit"></cover-image>
            </cover-view>
          </cover-view>
          
          <cover-view class="control-btn capture-btn" bindtap="takePhoto">
            <cover-view class="capture-inner"></cover-view>
          </cover-view>
          
          <cover-view class="control-btn placeholder-btn"></cover-view>
        </cover-view>
      </cover-view>
    </camera>
  </view>

  <!-- 操作选择界面 -->
  <view class="action-view" wx:if="{{currentStep === 'action'}}">
    <view class="action-header" style="padding-top: {{statusBarHeight}}px; height: {{menuButtonInfo.height}}px;">
      <view class="action-title">选择操作</view>
    </view>
    
    <view class="action-preview">
      <image class="preview-image" src="{{capturedImagePath}}" mode="aspectFit"></image>
    </view>
    
    <view class="action-buttons">
      <view class="action-card meal-card" bindtap="onMealCheckin">
        <image class="card-icon" src="/assets/take-picture/icon-singin.png" mode="aspectFit"></image>
        <view class="card-title">饮食打卡</view>
        <view class="card-desc">记录今日饮食</view>
      </view>
      
      <view class="action-card ai-card" bindtap="askXiaozhi">
        <image class="card-icon" src="/assets/logo/logo.png" mode="aspectFit"></image>
        <view class="card-title">询问小智</view>
        <view class="card-desc">AI智能分析</view>
      </view>
    </view>
    
    <view class="action-footer">
      <view class="footer-btn" bindtap="retake">
        <text>重新拍摄</text>
      </view>
    </view>

    <!-- 内容区域 -->
    <view class="content-area" wx:if="{{showContent}}">
      <!-- 饮食打卡列表 -->
      <view class="meal-checkin-list" wx:if="{{contentType === 'meal'}}">
        <view class="meal-card" wx:for="{{mealCheckinList}}" wx:key="type">
          <!-- 卡片头部 -->
          <view class="meal-card-header">
            <view class="meal-header-left">
              <image class="meal-type-icon" src="{{item.icon}}" mode="aspectFit"></image>
              <text class="meal-type-name">{{item.label}}打卡</text>
            </view>
            <view class="meal-header-right">
              <view class="add-food-btn" bindtap="onAddFood" data-type="{{item.type}}">
                <image class="add-icon" src="/assets/take-picture/icon-add.png" mode="aspectFit"></image>
                <text class="add-text">添加食物</text>
              </view>
              <view class="meal-status {{item.checked ? 'checked' : ''}}">
                <text class="status-text">{{item.checked ? '已打卡' : '未打卡'}}</text>
              </view>
              <image class="meal-status-icon" src="/assets/take-picture/icon-status.png" mode="aspectFit"></image>
            </view>
          </view>
          
          <!-- 食物列表 -->
          <view class="food-list">
            <view class="food-item {{food.placeholder ? 'placeholder' : ''}}" wx:for="{{item.foods}}" wx:for-item="food" wx:key="id">
              <view class="food-item-content" bindtap="{{food.placeholder ? 'onFillPlaceholder' : ''}}" data-type="{{item.type}}" data-id="{{food.id}}">
                <image class="food-image" src="{{food.image || '/assets/index/icon-wuchan.png'}}" mode="aspectFill"></image>
                <view class="food-info">
                  <text class="food-name" wx:if="{{!food.placeholder}}">{{food.name}}</text>
                  <text class="food-name placeholder-text" wx:else>点击添加食物</text>
                  <text class="food-calories" wx:if="{{!food.placeholder}}">{{food.calories}} 千卡</text>
                </view>
              </view>
              <view class="food-delete" wx:if="{{!food.placeholder}}" catchtap="onDeleteFood" data-type="{{item.type}}" data-id="{{food.id}}">
                <image class="delete-icon" src="/assets/take-picture/icon-delete.png" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- AI回复内容 -->
      <view class="ai-response-area" wx:if="{{contentType === 'ai'}}">
        <view class="ai-response-content">
          <view class="ai-response-item" wx:for="{{aiResponseList}}" wx:key="index">
            <text class="ai-text">{{item}}</text>
          </view>
          <view class="ai-loading" wx:if="{{aiLoading}}">
            <text class="loading-text">小智正在思考...</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 隐藏的canvas用于图片裁剪 -->
<canvas canvas-id="cropCanvas" style="position: fixed; left: -9999px; top: -9999px; width: {{frameSize}}px; height: {{frameSize}}px;"></canvas>
